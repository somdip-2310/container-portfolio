<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: head('Billing')}"></head>
<body>
    <header th:replace="~{fragments/base :: header}"></header>
    <aside th:replace="~{fragments/base :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="lg:ml-64 min-h-screen bg-gray-50 dark:bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- FREE Plan Usage Banner -->
            <div th:replace="~{fragments/base :: freeTierBanner}"></div>

            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Billing & Usage</h1>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Manage your subscription and view usage details</p>
            </div>

            <!-- Current Plan -->
            <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg shadow-xl p-8 text-white mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">
                            <span th:text="${subscriptionPlan != null ? subscriptionPlan : 'FREE'}">FREE</span> Plan
                        </h2>
                        <p class="text-purple-100 mb-4">
                            Status: <span class="font-semibold" th:text="${subscriptionStatus != null ? subscriptionStatus : 'ACTIVE'}">ACTIVE</span>
                        </p>
                        <!-- Dynamic plan benefits based on subscriptionPlan -->
                        <div class="space-y-2 text-sm">
                            <!-- FREE Plan Benefits -->
                            <th:block th:if="${subscriptionPlan == null || subscriptionPlan == 'FREE'}">
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>1 Container</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>256 MB RAM/container</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>5 GB Storage</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>10 GB Bandwidth</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Subdomain</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Community Support</span></div>
                            </th:block>
                            <!-- STARTER Plan Benefits -->
                            <th:block th:if="${subscriptionPlan == 'STARTER'}">
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>3 Containers</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>512 MB RAM/container</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>2 GB Storage</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>50 GB Bandwidth</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>1 Custom Domain</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Email Support (24hr)</span></div>
                            </th:block>
                            <!-- PRO Plan Benefits -->
                            <th:block th:if="${subscriptionPlan == 'PRO'}">
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>8 Containers</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>1 GB RAM/container</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>10 GB Storage</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>200 GB Bandwidth</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>5 Custom Domains</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Priority Support (4hr)</span></div>
                            </th:block>
                            <!-- BUSINESS Plan Benefits -->
                            <th:block th:if="${subscriptionPlan == 'BUSINESS'}">
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>20 Containers</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>2 GB RAM/container</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>50 GB Storage</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>1 TB Bandwidth</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Unlimited Domains</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>24/7 Support (1hr)</span></div>
                            </th:block>
                            <!-- ENTERPRISE Plan Benefits -->
                            <th:block th:if="${subscriptionPlan == 'ENTERPRISE'}">
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Custom Containers</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Up to 16 GB RAM</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Custom Storage</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Custom Bandwidth</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Unlimited Domains</span></div>
                                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Dedicated Support</span></div>
                            </th:block>
                        </div>
                    </div>
                    <div class="text-right">
                        <!-- Dynamic pricing based on plan -->
                        <th:block th:if="${subscriptionPlan == null || subscriptionPlan == 'FREE'}">
                            <div class="text-4xl font-bold mb-2">Free</div>
                            <div class="text-purple-100 text-sm">Forever</div>
                        </th:block>
                        <th:block th:if="${subscriptionPlan == 'STARTER'}">
                            <div class="text-4xl font-bold mb-2">$39<span class="text-lg">/mo</span></div>
                            <div class="text-purple-100 text-sm">~₹3,500/mo</div>
                        </th:block>
                        <th:block th:if="${subscriptionPlan == 'PRO'}">
                            <div class="text-4xl font-bold mb-2">$89<span class="text-lg">/mo</span></div>
                            <div class="text-purple-100 text-sm">~₹7,950/mo</div>
                        </th:block>
                        <th:block th:if="${subscriptionPlan == 'BUSINESS'}">
                            <div class="text-4xl font-bold mb-2">$169<span class="text-lg">/mo</span></div>
                            <div class="text-purple-100 text-sm">~₹15,100/mo</div>
                        </th:block>
                        <th:block th:if="${subscriptionPlan == 'ENTERPRISE'}">
                            <div class="text-4xl font-bold mb-2">Custom</div>
                            <div class="text-purple-100 text-sm">Contact Sales</div>
                        </th:block>
                        <button onclick="showUpgradeModal()"
                                class="mt-4 bg-white text-purple-600 hover:bg-purple-50 font-semibold py-2 px-6 rounded-lg transition">
                            Upgrade Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Usage Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Containers Usage -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Containers</h3>
                        <i class="fas fa-box text-purple-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${containerCount != null ? containerCount : 0} + ' of ' + ${containerLimit != null ? containerLimit : 1} + ' used'">0 of 1 used</span>
                            <span th:text="${containerPercentage != null ? containerPercentage : 0} + '%'">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full" th:style="'width: ' + ${containerPercentage != null ? containerPercentage : 0} + '%'"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3" th:text="${containersRemaining != null ? containersRemaining : 1} + ' more container(s) available'">1 more container(s) available</p>
                </div>

                <!-- Bandwidth Usage -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Bandwidth</h3>
                        <i class="fas fa-network-wired text-blue-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${bandwidthUsedGb != null ? bandwidthUsedGb : '0.0'} + ' GB of ' + ${bandwidthLimitGb != null ? bandwidthLimitGb : 10} + ' GB'">0.0 GB of 10 GB</span>
                            <span th:text="${bandwidthPercentage != null ? bandwidthPercentage : 0} + '%'">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" th:style="'width: ' + ${bandwidthPercentage != null ? bandwidthPercentage : 0} + '%'"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3" th:text="${bandwidthRemaining != null ? bandwidthRemaining : '10.0'} + ' GB remaining this month'">10.0 GB remaining this month</p>
                </div>

                <!-- CPU Hours -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">CPU Hours</h3>
                        <i class="fas fa-microchip text-green-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${cpuHoursUsed != null ? cpuHoursUsed : 0} + ' hours used'">0 hours used</span>
                            <span>This month</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 dark:text-white" th:text="${cpuHoursUsed != null ? cpuHoursUsed : 0} + 'h'">0h</div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">Based on container runtime this billing period</p>
                </div>
            </div>

            <!-- Billing History -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden mb-8">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Billing History</h3>
                </div>
                <div id="billingHistoryContainer" class="overflow-x-auto">
                    <!-- Loading state -->
                    <div id="billingHistoryLoading" class="p-8 text-center">
                        <i class="fas fa-spinner fa-spin text-purple-500 text-2xl"></i>
                        <p class="mt-2 text-gray-500 dark:text-gray-400">Loading billing history...</p>
                    </div>
                    <!-- Empty state -->
                    <div id="billingHistoryEmpty" class="hidden p-8 text-center">
                        <i class="fas fa-receipt text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">No billing history yet</p>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Your payment transactions will appear here</p>
                    </div>
                    <!-- Table -->
                    <table id="billingHistoryTable" class="w-full hidden">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="billingHistoryBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Choose Your Plan</h3>
                    <button onclick="hideUpgradeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Billing Period Toggle -->
                <div class="flex justify-center mb-6">
                    <div class="inline-flex rounded-lg border border-gray-300 dark:border-gray-600 p-1">
                        <button id="monthlyBtn" onclick="switchBilling('monthly')" class="px-4 py-2 text-sm font-medium rounded-md bg-purple-600 text-white">
                            Monthly
                        </button>
                        <button id="quarterlyBtn" onclick="switchBilling('quarterly')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Quarterly <span class="text-xs text-green-600 dark:text-green-400 ml-1">(Save 10%)</span>
                        </button>
                        <button id="annualBtn" onclick="switchBilling('annual')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Annual <span class="text-xs text-green-600 dark:text-green-400 ml-1">(Save 17%)</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <!-- Free Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col" th:classappend="${subscriptionPlan == null || subscriptionPlan == 'FREE'} ? 'ring-2 ring-purple-500' : ''">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">FREE TIER</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Free</div>
                        <p class="text-xs text-gray-500 mb-4">Trial users, Students</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">200 hours runtime/month</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 Container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">256 MB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">5 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Subdomain</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Community Support</span></li>
                        </ul>
                        <button th:if="${subscriptionPlan == null || subscriptionPlan == 'FREE'}" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Current Plan</button>
                        <button th:unless="${subscriptionPlan == null || subscriptionPlan == 'FREE'}" class="w-full bg-gray-400 text-white font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Downgrade N/A</button>
                    </div>

                    <!-- Starter Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col" th:classappend="${subscriptionPlan == 'STARTER'} ? 'ring-2 ring-purple-500' : ''">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">STARTER</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="39">$39</span>
                            <span class="quarterly-price hidden" data-usd="35">$35</span>
                            <span class="annual-price hidden" data-usd="33">$33</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="39" data-quarterly="35" data-annual="33">~₹3,250/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Indie developers, Freelancers</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">3 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">512 MB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">2 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">50 GB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 Custom Domain</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Email (24hr)</span></li>
                        </ul>
                        <button th:if="${subscriptionPlan == 'STARTER'}" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Current Plan</button>
                        <button th:unless="${subscriptionPlan == 'STARTER'}" onclick="initiateUpgrade('STARTER')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Starter</button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="border-2 border-purple-600 rounded-lg p-6 relative flex flex-col" th:classappend="${subscriptionPlan == 'PRO'} ? 'ring-2 ring-purple-500' : ''">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full">POPULAR</span>
                        </div>
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">PRO</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="89">$89</span>
                            <span class="quarterly-price hidden" data-usd="80">$80</span>
                            <span class="annual-price hidden" data-usd="75">$75</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="89" data-quarterly="80" data-annual="75">~₹7,425/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Small startups, Agencies</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">8 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 GB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">10 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">200 GB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">5 Custom Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Priority (4hr)</span></li>
                        </ul>
                        <button th:if="${subscriptionPlan == 'PRO'}" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Current Plan</button>
                        <button th:unless="${subscriptionPlan == 'PRO'}" onclick="initiateUpgrade('PRO')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Pro</button>
                    </div>

                    <!-- Business Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col" th:classappend="${subscriptionPlan == 'BUSINESS'} ? 'ring-2 ring-purple-500' : ''">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">BUSINESS</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="169">$169</span>
                            <span class="quarterly-price hidden" data-usd="152">$152</span>
                            <span class="annual-price hidden" data-usd="142">$142</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="169" data-quarterly="152" data-annual="142">~₹14,100/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Growing companies, Teams</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">20 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">2 GB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">50 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 TB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Unlimited Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">24/7 Support (1hr)</span></li>
                        </ul>
                        <button th:if="${subscriptionPlan == 'BUSINESS'}" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Current Plan</button>
                        <button th:unless="${subscriptionPlan == 'BUSINESS'}" onclick="initiateUpgrade('BUSINESS')" class="w-full bg-gray-900 dark:bg-gray-700 text-white hover:bg-gray-800 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Business</button>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col" th:classappend="${subscriptionPlan == 'ENTERPRISE'} ? 'ring-2 ring-purple-500' : ''">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ENTERPRISE</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Custom</div>
                        <p class="text-xs text-gray-500 mb-4">Large enterprise</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Up to 16GB RAM</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Unlimited Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Dedicated Support</span></li>
                        </ul>
                        <button th:if="${subscriptionPlan == 'ENTERPRISE'}" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Current Plan</button>
                        <button th:unless="${subscriptionPlan == 'ENTERPRISE'}" class="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 hover:bg-gray-800 dark:hover:bg-gray-100 font-medium py-2 px-4 rounded-lg transition text-sm">Contact Sales</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let exchangeRate = 83.5; // Fallback rate
        let currentBillingPeriod = 'monthly';

        // Fetch live exchange rate on page load
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
                const data = await response.json();
                if (data.rates && data.rates.INR) {
                    exchangeRate = data.rates.INR;
                    updateAllInrDisplays();
                }
            } catch (error) {
                console.log('Using fallback exchange rate');
            }
        }

        function formatInr(usd) {
            const inr = Math.round(usd * exchangeRate / 50) * 50; // Round to nearest 50
            return inr.toLocaleString('en-IN');
        }

        function updateAllInrDisplays() {
            document.querySelectorAll('.inr-display').forEach(el => {
                const usd = parseFloat(el.dataset[currentBillingPeriod]);
                if (usd) {
                    el.textContent = '~₹' + formatInr(usd) + '/mo';
                }
            });
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            fetchExchangeRate(); // Refresh rate when modal opens
        }

        function hideUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function initiateUpgrade(plan) {
            // Get the billing period and redirect to subscription API
            const billingPeriod = currentBillingPeriod.toUpperCase();
            window.location.href = `/api/subscription/checkout?plan=${plan}&billingPeriod=${billingPeriod}`;
        }

        function switchBilling(period) {
            currentBillingPeriod = period;

            // Update button styles
            document.querySelectorAll('#monthlyBtn, #quarterlyBtn, #annualBtn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });

            if (period === 'monthly') {
                document.getElementById('monthlyBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('monthlyBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            } else if (period === 'quarterly') {
                document.getElementById('quarterlyBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('quarterlyBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            } else if (period === 'annual') {
                document.getElementById('annualBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('annualBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }

            // Hide all prices
            document.querySelectorAll('.monthly-price, .quarterly-price, .annual-price').forEach(el => {
                el.classList.add('hidden');
            });

            // Show selected period prices
            document.querySelectorAll(`.${period}-price`).forEach(el => {
                el.classList.remove('hidden');
            });

            // Update INR displays for the new billing period
            updateAllInrDisplays();
        }

        // Billing History Functions
        async function fetchBillingHistory() {
            const loadingEl = document.getElementById('billingHistoryLoading');
            const emptyEl = document.getElementById('billingHistoryEmpty');
            const tableEl = document.getElementById('billingHistoryTable');
            const bodyEl = document.getElementById('billingHistoryBody');

            try {
                const response = await fetch('/api/payments/history');
                if (!response.ok) throw new Error('Failed to fetch billing history');

                const transactions = await response.json();
                loadingEl.classList.add('hidden');

                if (!transactions || transactions.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                // Sort by createdAt descending
                transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Render transactions
                bodyEl.innerHTML = transactions.map(tx => renderTransactionRow(tx)).join('');
                tableEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching billing history:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
            }
        }

        function renderTransactionRow(tx) {
            const date = new Date(tx.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const amount = tx.currency === 'INR'
                ? `₹${(tx.amount / 100).toLocaleString('en-IN')}`
                : `$${(tx.amount / 100).toFixed(2)}`;

            const description = tx.description || `${tx.planName || 'Subscription'} Plan`;

            const statusClasses = getStatusClasses(tx.status);
            const statusText = formatStatus(tx.status);

            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">${amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium ${statusClasses} rounded">${statusText}</span>
                    </td>
                </tr>
            `;
        }

        function getStatusClasses(status) {
            switch (status) {
                case 'CAPTURED':
                    return 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                case 'REFUNDED':
                case 'PARTIALLY_REFUNDED':
                    return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                case 'FAILED':
                    return 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
                case 'AUTHORIZED':
                case 'CREATED':
                    return 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
                default:
                    return 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
            }
        }

        function formatStatus(status) {
            switch (status) {
                case 'CAPTURED': return 'Paid';
                case 'REFUNDED': return 'Refunded';
                case 'PARTIALLY_REFUNDED': return 'Partial Refund';
                case 'FAILED': return 'Failed';
                case 'AUTHORIZED': return 'Processing';
                case 'CREATED': return 'Pending';
                default: return status;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchExchangeRate();
            fetchBillingHistory();
        });
    </script>
</body>
</html>
