<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: head('Billing')}"></head>
<body>
    <header th:replace="~{fragments/base :: header}"></header>
    <aside th:replace="~{fragments/base :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="lg:ml-64 min-h-screen bg-gray-50 dark:bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- FREE Plan Usage Banner -->
            <div th:replace="~{fragments/base :: freeTierBanner}"></div>

            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Billing & Usage</h1>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Manage your subscription and view usage details</p>
            </div>

            <!-- Current Plan -->
            <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg shadow-xl p-8 text-white mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">
                            <span th:text="${subscriptionPlan != null ? subscriptionPlan : 'Free'}">Free</span> Plan
                        </h2>
                        <p class="text-purple-100 mb-4">
                            Status: <span class="font-semibold" th:text="${subscriptionStatus != null ? subscriptionStatus : 'Active'}">Active</span>
                        </p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>1 Container</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>256 MB RAM/container</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>500 MB Storage</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>10 GB Bandwidth</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>Subdomain</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>Community Support</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold mb-2">Free</div>
                        <div class="text-purple-100 text-sm">Forever</div>
                        <button onclick="showUpgradeModal()"
                                class="mt-4 bg-white text-purple-600 hover:bg-purple-50 font-semibold py-2 px-6 rounded-lg transition">
                            Upgrade Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Usage Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Containers Usage -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Containers</h3>
                        <i class="fas fa-box text-purple-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${containerCount != null ? containerCount : 0} + ' of ' + ${containerLimit != null ? containerLimit : 1} + ' used'">0 of 1 used</span>
                            <span th:text="${containerPercentage != null ? containerPercentage : 0} + '%'">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full" th:style="'width: ' + ${containerPercentage != null ? containerPercentage : 0} + '%'"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3" th:text="${containersRemaining != null ? containersRemaining : 1} + ' more container(s) available'">1 more container(s) available</p>
                </div>

                <!-- Bandwidth Usage -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Bandwidth</h3>
                        <i class="fas fa-network-wired text-blue-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${bandwidthUsedGb != null ? bandwidthUsedGb : '0.0'} + ' GB of ' + ${bandwidthLimitGb != null ? bandwidthLimitGb : 10} + ' GB'">0.0 GB of 10 GB</span>
                            <span th:text="${bandwidthPercentage != null ? bandwidthPercentage : 0} + '%'">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" th:style="'width: ' + ${bandwidthPercentage != null ? bandwidthPercentage : 0} + '%'"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3" th:text="${bandwidthRemaining != null ? bandwidthRemaining : '10.0'} + ' GB remaining this month'">10.0 GB remaining this month</p>
                </div>

                <!-- CPU Hours -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">CPU Hours</h3>
                        <i class="fas fa-microchip text-green-500 text-2xl"></i>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                            <span th:text="${cpuHoursUsed != null ? cpuHoursUsed : 0} + ' hours used'">0 hours used</span>
                            <span>This month</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 dark:text-white" th:text="${cpuHoursUsed != null ? cpuHoursUsed : 0} + 'h'">0h</div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">Based on container runtime this billing period</p>
                </div>
            </div>

            <!-- Billing History -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden mb-8">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Billing History</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Invoice</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">Jan 1, 2024</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Free Plan - January 2024</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">$0.00</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                                        Paid
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        <i class="fas fa-download mr-1"></i>
                                        Download
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">Dec 1, 2023</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Free Plan - December 2023</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">$0.00</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                                        Paid
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        <i class="fas fa-download mr-1"></i>
                                        Download
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Payment Method</h3>
                <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                            <i class="fas fa-credit-card text-2xl text-gray-600 dark:text-gray-400"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">No payment method</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">You're on the free plan</div>
                        </div>
                    </div>
                    <button onclick="addPaymentMethod()"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition">
                        Add Payment Method
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Choose Your Plan</h3>
                    <button onclick="hideUpgradeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Billing Period Toggle -->
                <div class="flex justify-center mb-6">
                    <div class="inline-flex rounded-lg border border-gray-300 dark:border-gray-600 p-1">
                        <button id="monthlyBtn" onclick="switchBilling('monthly')" class="px-4 py-2 text-sm font-medium rounded-md bg-purple-600 text-white">
                            Monthly
                        </button>
                        <button id="quarterlyBtn" onclick="switchBilling('quarterly')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Quarterly <span class="text-xs text-green-600 dark:text-green-400 ml-1">(Save 10%)</span>
                        </button>
                        <button id="annualBtn" onclick="switchBilling('annual')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Annual <span class="text-xs text-green-600 dark:text-green-400 ml-1">(Save 17%)</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <!-- Free Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">FREE TIER</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Free</div>
                        <p class="text-xs text-gray-500 mb-4">Trial users, Students</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">200 hours runtime/month</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 Container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">256 MB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">5 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Subdomain</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Community Support</span></li>
                        </ul>
                        <button class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm" disabled>Current Plan</button>
                    </div>

                    <!-- Starter Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">STARTER</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="39">$39</span>
                            <span class="quarterly-price hidden" data-usd="35">$35</span>
                            <span class="annual-price hidden" data-usd="33">$33</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="39" data-quarterly="35" data-annual="33">~₹3,250/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Indie developers, Freelancers</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">3 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">512 MB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">2 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">50 GB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 Custom Domain</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Email (24hr)</span></li>
                        </ul>
                        <button onclick="initiatePayment('STARTER')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Starter</button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="border-2 border-purple-600 rounded-lg p-6 relative flex flex-col">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full">⭐ POPULAR</span>
                        </div>
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">PRO</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="89">$89</span>
                            <span class="quarterly-price hidden" data-usd="80">$80</span>
                            <span class="annual-price hidden" data-usd="75">$75</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="89" data-quarterly="80" data-annual="75">~₹7,425/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Small startups, Agencies</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">8 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 GB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">10 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">200 GB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">5 Custom Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Priority (4hr)</span></li>
                        </ul>
                        <button onclick="initiatePayment('PRO')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Pro</button>
                    </div>

                    <!-- Business Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">BUSINESS</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                            <span class="monthly-price" data-usd="169">$169</span>
                            <span class="quarterly-price hidden" data-usd="152">$152</span>
                            <span class="annual-price hidden" data-usd="142">$142</span>
                            <span class="text-sm text-gray-500">/mo</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-1 inr-display" data-monthly="169" data-quarterly="152" data-annual="142">~₹14,100/mo</p>
                        <p class="text-xs text-gray-500 mb-4">Growing companies, Teams</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">20 Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">2 GB RAM/container</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">50 GB Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">1 TB Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Unlimited Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">24/7 Support (1hr)</span></li>
                        </ul>
                        <button onclick="initiatePayment('BUSINESS')" class="w-full bg-gray-900 dark:bg-gray-700 text-white hover:bg-gray-800 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-lg transition text-sm">Upgrade to Business</button>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-6 flex flex-col">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ENTERPRISE</h4>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Custom</div>
                        <p class="text-xs text-gray-500 mb-4">Large enterprise</p>
                        <ul class="space-y-2 mb-6 flex-grow text-sm">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Containers</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Up to 16GB RAM</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Storage</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Custom Bandwidth</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Unlimited Domains</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1 text-xs"></i><span class="text-gray-600 dark:text-gray-400">Dedicated Support</span></li>
                        </ul>
                        <button onclick="contactSales()" class="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 hover:bg-gray-800 dark:hover:bg-gray-100 font-medium py-2 px-4 rounded-lg transition text-sm">Contact Sales</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Razorpay Checkout SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script th:inline="javascript">
        let exchangeRate = 83.5; // Fallback rate
        let currentBillingPeriod = 'monthly';

        // Razorpay configuration
        const razorpayKeyId = /*[[${@environment.getProperty('razorpay.key.id')}]]*/ 'rzp_test_RlQVkwHFJu9xDA';
        const userEmail = /*[[${#authentication.principal.username}]]*/ '';

        // Plan pricing in INR paise (100 paise = 1 INR) - matches Razorpay plans
        // Discounts: Quarterly = 10% off, Annual = 17% off
        const planPricing = {
            'STARTER': { monthly: 350000, quarterly: 945000, annual: 3486000, name: 'Starter Plan' },
            'PRO': { monthly: 795000, quarterly: 2146500, annual: 7918200, name: 'Pro Plan' },
            'BUSINESS': { monthly: 1510000, quarterly: 4077000, annual: 15039600, name: 'Business Plan' }
        };

        // Fetch live exchange rate on page load
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
                const data = await response.json();
                if (data.rates && data.rates.INR) {
                    exchangeRate = data.rates.INR;
                    updateAllInrDisplays();
                }
            } catch (error) {
                console.log('Using fallback exchange rate');
            }
        }

        function formatInr(usd) {
            const inr = Math.round(usd * exchangeRate / 50) * 50; // Round to nearest 50
            return inr.toLocaleString('en-IN');
        }

        function updateAllInrDisplays() {
            document.querySelectorAll('.inr-display').forEach(el => {
                const usd = parseFloat(el.dataset[currentBillingPeriod]);
                if (usd) {
                    el.textContent = '~₹' + formatInr(usd) + '/mo';
                }
            });
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            fetchExchangeRate(); // Refresh rate when modal opens
        }

        function hideUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function addPaymentMethod() {
            showUpgradeModal();
        }

        function contactSales() {
            window.location.href = '/contact?subject=Enterprise%20Plan%20Inquiry';
        }

        // Initiate Razorpay payment
        async function initiatePayment(plan) {
            const pricing = planPricing[plan];
            if (!pricing) {
                showNotification('Invalid plan selected', 'error');
                return;
            }

            const billingPeriodKey = currentBillingPeriod === 'annual' ? 'annual' :
                                     currentBillingPeriod === 'quarterly' ? 'quarterly' : 'monthly';
            const amount = pricing[billingPeriodKey];

            try {
                // Show loading state
                showNotification('Creating payment order...', 'info');

                // Create order on server
                const response = await fetch('/api/payments/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        plan: plan,
                        billingPeriod: currentBillingPeriod
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create order');
                }

                const orderData = await response.json();

                // Open Razorpay checkout
                const options = {
                    key: razorpayKeyId,
                    amount: orderData.amount,
                    currency: orderData.currency || 'INR',
                    name: 'SnapDeploy',
                    description: `${pricing.name} - ${currentBillingPeriod}`,
                    order_id: orderData.orderId,
                    handler: function(response) {
                        // Verify payment on server
                        verifyPayment(response, plan);
                    },
                    prefill: {
                        email: userEmail
                    },
                    theme: {
                        color: '#7c3aed'
                    },
                    modal: {
                        ondismiss: function() {
                            showNotification('Payment cancelled', 'warning');
                        }
                    }
                };

                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function(response) {
                    showNotification('Payment failed: ' + response.error.description, 'error');
                });
                rzp.open();

            } catch (error) {
                console.error('Payment error:', error);
                showNotification('Failed to initiate payment. Please try again.', 'error');
            }
        }

        // Verify payment after successful Razorpay checkout
        async function verifyPayment(razorpayResponse, plan) {
            try {
                showNotification('Verifying payment...', 'info');

                const response = await fetch('/api/payments/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        razorpayOrderId: razorpayResponse.razorpay_order_id,
                        razorpayPaymentId: razorpayResponse.razorpay_payment_id,
                        razorpaySignature: razorpayResponse.razorpay_signature,
                        plan: plan
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Payment successful! Your plan has been upgraded.', 'success');
                    hideUpgradeModal();
                    // Reload page to show new plan
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showNotification('Payment verification failed. Please contact support.', 'error');
                }

            } catch (error) {
                console.error('Verification error:', error);
                showNotification('Failed to verify payment. Please contact support.', 'error');
            }
        }

        // Show notification toast
        function showNotification(message, type) {
            // Remove existing notifications
            const existing = document.querySelector('.payment-notification');
            if (existing) existing.remove();

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `payment-notification fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function switchBilling(period) {
            currentBillingPeriod = period;

            // Update button styles
            document.querySelectorAll('#monthlyBtn, #quarterlyBtn, #annualBtn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });

            if (period === 'monthly') {
                document.getElementById('monthlyBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('monthlyBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            } else if (period === 'quarterly') {
                document.getElementById('quarterlyBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('quarterlyBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            } else if (period === 'annual') {
                document.getElementById('annualBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('annualBtn').classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }

            // Hide all prices
            document.querySelectorAll('.monthly-price, .quarterly-price, .annual-price').forEach(el => {
                el.classList.add('hidden');
            });

            // Show selected period prices
            document.querySelectorAll(`.${period}-price`).forEach(el => {
                el.classList.remove('hidden');
            });

            // Update INR displays for the new billing period
            updateAllInrDisplays();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchExchangeRate();
        });
    </script>
</body>
</html>
